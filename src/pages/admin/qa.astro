---
import BaseLayout from "../../layouts/BaseLayout.astro";
---

<BaseLayout title="Admin: Q&A Moderation | Lou Gehrig Fan Club" requireAuth={true} requireAdmin={true}>
  <p><a class="underline" href="/admin">← Back to Admin Dashboard</a></p>
  <h1 class="text-2xl font-semibold mb-4">Q&amp;A Moderation</h1>
  <p id="status" class="text-gray-600">Loading…</p>
  <ul id="threads" class="space-y-3 mt-3"></ul>

  <script type="module">
    import { createClient } from '@supabase/supabase-js';
    const supabase = createClient(import.meta.env.VITE_SUPABASE_URL, import.meta.env.VITE_SUPABASE_ANON_KEY);

    const statusEl = document.getElementById('status');
    const threadsEl = document.getElementById('threads');

    function row(t) {
      const li = document.createElement('li');
      li.className = 'border rounded bg-white p-3 flex items-start justify-between gap-4';
      li.innerHTML = `
        <div>
          <div class="font-semibold">${t.title}</div>
          <div class="text-xs text-gray-500">${new Date(t.created_at).toLocaleString()}</div>
          ${t.body ? `<p class="mt-1 text-sm">${t.body}</p>` : ''}
        </div>
        <div class="flex gap-2">
          <button class="border rounded px-3 py-1" data-action="delete">Delete</button>
        </div>
      `;
      li.querySelector('[data-action="delete"]').addEventListener('click', async () => {
        if (!confirm('Delete this thread?')) return;
        const { error } = await supabase.from('qa_threads').delete().eq('id', t.id);
        if (error) alert(error.message); else load();
      });
      return li;
    }

    async function load() {
      statusEl.textContent = 'Loading…';
      threadsEl.innerHTML = '';
      const { data, error } = await supabase
        .from('qa_threads')
        .select('*')
        .order('created_at', { ascending: false })
        .limit(100);
      if (error) {
        statusEl.textContent = `Error: ${error.message}`;
        return;
      }
      if (!data?.length) {
        statusEl.textContent = 'No threads yet.';
        return;
      }
      statusEl.remove();
      for (const t of data) threadsEl.appendChild(row(t));
    }

    load();
  </script>
</BaseLayout>