---
import BaseLayout from "../layouts/BaseLayout.astro";
---

<BaseLayout title="The Lou Gehrig Fan Club" description="Honoring the Iron Horse legacy and supporting the ALS community.">
  <section class="relative min-h-screen bg-slate-50 text-slate-900">
    <!-- Hero -->
    <div class="relative bg-white text-slate-900 py-16 px-6 border-b border-slate-200">
      <a href="/members/home" class="absolute top-4 right-4 inline-flex items-center px-4 py-2 border border-slate-300 rounded-md text-sm font-medium text-slate-900 hover:bg-slate-100 transition-colors">Club Home</a>
      <div class="max-w-6xl mx-auto text-center">
        <h1 class="text-5xl font-bold mb-4">The Lou Gehrig Fan Club</h1>
        <p class="text-xl opacity-90">Celebrating the life & legacy of the Iron Horse</p>
      </div>
    </div>

    <!-- Photo Voting -->
    <div class="py-16 px-6 bg-white">
      <div class="max-w-5xl mx-auto">
        <h2 class="text-3xl font-bold text-center mb-12">Vote for Your Favorite Lou Gehrig Photo</h2>
        <div class="grid md:grid-cols-2 gap-8">
          <div class="border border-slate-200 rounded-xl bg-white overflow-hidden shadow-sm">
            <div class="p-6">
              <div class="aspect-[4/5] bg-slate-100 rounded-lg mb-4 flex items-center justify-center overflow-hidden">
                <img src="https://readdy.ai/api/search-image?query=Lou%20Gehrig%20in%20classic%20New%20York%20Yankees%20pinstripe%20uniform%20swinging%20baseball%20bat%20at%20home%20plate%2C%20vintage%20black%20and%20white%20photography%20style%2C%20Yankee%20Stadium%20background%2C%201930s%20baseball%20action%20shot%2C%20iconic%20sports%20moment&width=400&height=500&seq=gehrig1&orientation=portrait" alt="Lou Gehrig batting stance" class="w-full h-full object-cover" />
              </div>
              <div class="flex items-center justify-between">
                <h3 class="font-semibold text-lg">The Iron Horse at Bat</h3>
                <button data-image="gehrig1" class="btn-secondary vote-btn" type="button">Vote</button>
              </div>
              <p class="text-slate-600 mt-2">Classic batting stance, 1932</p>
              <div class="mt-2"><a href="/leaderboard" class="text-sm text-blue-700 hover:underline">Go to leaderboard ‚Üí</a></div>
            </div>
          </div>

          <div class="border border-slate-200 rounded-xl bg-white overflow-hidden shadow-sm">
            <div class="p-6">
              <div class="aspect-[4/5] bg-slate-100 rounded-lg mb-4 flex items-center justify-center overflow-hidden">
                <img src="https://readdy.ai/api/search-image?query=Lou%20Gehrig%20in%20New%20York%20Yankees%20uniform%20giving%20farewell%20speech%20at%20Yankee%20Stadium%2C%20emotional%20moment%2C%20crowd%20in%20background%2C%20vintage%201939%20baseball%20photography%2C%20historic%20sports%20farewell%20ceremony&width=400&height=500&seq=gehrig2&orientation=portrait" alt="Lou Gehrig farewell speech" class="w-full h-full object-cover" />
              </div>
              <div class="flex items-center justify-between">
                <h3 class="font-semibold text-lg">Farewell Speech</h3>
                <button data-image="gehrig2" class="btn-secondary vote-btn" type="button">Vote</button>
              </div>
              <p class="text-slate-600 mt-2">July 4, 1939 - "Luckiest man"</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Join / Login -->
    <div class="py-12 px-6 bg-white">
      <div class="max-w-2xl mx-auto text-center">
        <div class="flex flex-col sm:flex-row gap-4 justify-center">
          <a class="btn-primary text-lg px-8 py-6" href="/join">Join the Club</a>
          <a class="btn-secondary !text-slate-900 text-lg px-8 py-6" href="/login">Members Login</a>
        </div>
      </div>
    </div>

    <!-- Fan Club News -->
    <div class="py-16 px-6 bg-white">
      <div class="max-w-4xl mx-auto">
        <h2 class="text-3xl font-bold text-center mb-12">Fan Club News</h2>
        <div class="space-y-6">
          <div class="border border-slate-200 rounded-xl bg-white p-6 shadow-sm">
            <div class="flex justify-between items-start mb-3">
              <h3 class="font-semibold text-lg">Annual Lou Gehrig Day Celebration Planning Underway</h3>
              <span class="text-xs font-bold bg-red-100 text-red-700 px-2 py-1 rounded-full">47 likes</span>
            </div>
            <p class="text-slate-600 mb-2">Join us as we plan this year's tribute event at Yankee Stadium...</p>
            <p class="text-sm text-slate-500">3 days ago</p>
          </div>
          <div class="border border-slate-200 rounded-xl bg-white p-6 shadow-sm">
            <div class="flex justify-between items-start mb-3">
              <h3 class="font-semibold text-lg">New Gehrig Memorabilia Added to Club Collection</h3>
              <span class="text-xs font-bold bg-red-100 text-red-700 px-2 py-1 rounded-full">32 likes</span>
            </div>
            <p class="text-slate-600 mb-2">Rare photographs and documents from the Gehrig family archives...</p>
            <p class="text-sm text-slate-500">1 week ago</p>
          </div>
          <div class="border border-slate-200 rounded-xl bg-white p-6 shadow-sm">
            <div class="flex justify-between items-start mb-3">
              <h3 class="font-semibold text-lg">ALS Research Fundraiser Exceeds Goal</h3>
              <span class="text-xs font-bold bg-red-100 text-red-700 px-2 py-1 rounded-full">89 likes</span>
            </div>
            <p class="text-slate-600 mb-2">Thanks to our amazing community, we've raised over $50,000...</p>
            <p class="text-sm text-slate-500">2 weeks ago</p>
          </div>
        </div>
      </div>
    </div>

    <!-- ALS Community Support -->
    <div class="py-16 px-6 bg-slate-50">
      <div class="max-w-6xl mx-auto">
        <h2 class="text-3xl font-bold text-center mb-4">Lou Gehrig Fan Club Supports the ALS Community</h2>
        <p class="text-center text-slate-600 mb-12 max-w-2xl mx-auto">In honor of Lou Gehrig's legacy, we proudly support organizations fighting ALS and helping patients and families.</p>
        <div class="grid md:grid-cols-3 gap-8 mb-12">
          <div class="border border-slate-200 rounded-xl bg-white p-6 text-center shadow-sm">
            <h3 class="text-lg font-semibold mb-2 text-red-600">ALS CURE PROJECT</h3>
            <p class="text-slate-600 mb-4">Accelerating ALS research and drug development</p>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
              <a href="https://www.alscure.org" target="_blank" rel="noopener" class="btn-primary inline-block text-center">Learn More</a>
              <a href="https://paybee.io/quickpay.html?handle=alscure&ppid=32" target="_blank" rel="noopener" class="btn-primary inline-block text-center">Donate</a>
              <a href="https://www.alscure.org/research" target="_blank" rel="noopener" class="btn-primary inline-block text-center">Research</a>
            </div>
          </div>
          <div class="border border-slate-200 rounded-xl bg-white p-6 text-center shadow-sm">
            <h3 class="text-lg font-semibold mb-2 text-red-600">I AM ALS</h3>
            <p class="text-slate-600 mb-4">Patient-led organization transforming ALS care</p>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
              <a href="https://www.iamals.org" target="_blank" rel="noopener" class="btn-primary inline-block text-center">Learn More</a>
              <a href="https://www.iamals.org/give/" target="_blank" rel="noopener" class="btn-primary inline-block text-center">Donate</a>
              <a href="https://www.iamals.org/action/volunteer/" target="_blank" rel="noopener" class="btn-primary inline-block text-center">Volunteer</a>
            </div>
          </div>
          <div class="border border-slate-200 rounded-xl bg-white p-6 text-center shadow-sm">
            <h3 class="text-lg font-semibold mb-2 text-red-600">Live Like Lou</h3>
            <p class="text-slate-600 mb-4">Supporting ALS patients and their families</p>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
              <a href="https://www.livelikelou.org" target="_blank" rel="noopener" class="btn-primary inline-block text-center">Learn More</a>
              <a href="https://www.livelikelou.org/donate" target="_blank" rel="noopener" class="btn-primary inline-block text-center">Donate</a>
              <a href="https://www.livelikelou.org/als-families" target="_blank" rel="noopener" class="btn-primary inline-block text-center">Volunteer</a>
            </div>
          </div>
        </div>

        <!-- ALS Events Calendar -->
        <div class="border border-slate-200 rounded-xl bg-white p-6 shadow-sm">
          <h3 class="text-xl font-semibold mb-6 flex items-center gap-2"><span>üóìÔ∏è</span> ALS Community Events Calendar</h3>
          <div class="space-y-4">
            <div class="flex items-center justify-between p-4 bg-slate-50 rounded-lg">
              <div>
                <h4 class="font-medium">ALS Walk for Life - Central Park</h4>
                <p class="text-sm text-slate-600">New York, NY</p>
              </div>
              <span class="text-xs font-semibold bg-slate-200 text-slate-800 px-2 py-1 rounded">March 15, 2025</span>
            </div>
            <div class="flex items-center justify-between p-4 bg-slate-50 rounded-lg">
              <div>
                <h4 class="font-medium">Research Fundraising Gala</h4>
                <p class="text-sm text-slate-600">Manhattan</p>
              </div>
              <span class="text-xs font-semibold bg-slate-200 text-slate-800 px-2 py-1 rounded">April 22, 2025</span>
            </div>
            <div class="flex items-center justify-between p-4 bg-slate-50 rounded-lg">
              <div>
                <h4 class="font-medium">Lou Gehrig Appreciation Day</h4>
                <p class="text-sm text-slate-600">Yankee Stadium</p>
              </div>
              <span class="text-xs font-semibold bg-slate-200 text-slate-800 px-2 py-1 rounded">June 2, 2025</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Q&A + Milestones -->
    <div class="py-16 px-6 bg-white">
      <div class="max-w-6xl mx-auto grid md:grid-cols-2 gap-8">
        <div class="border border-slate-200 rounded-xl bg-white p-6 shadow-sm">
          <h3 class="text-xl font-semibold mb-4">FAQ and Q&A</h3>
          <input id="faq-search" class="w-full border rounded px-3 py-2 mb-3 text-slate-900 placeholder-gray-500" placeholder="Search questions‚Ä¶" />
          <div id="faq-list" class="divide-y divide-slate-200">
            <details class="py-3 group">
              <summary class="font-medium cursor-pointer flex items-center justify-between list-none">
                <span>When was Lou Gehrig born?</span>
                <span class="text-slate-400 group-open:rotate-180 transition-transform">‚åÑ</span>
              </summary>
              <p class="text-sm text-slate-600 mt-2">June 19, 1903 in New York City</p>
            </details>
            <details class="py-3 group">
              <summary class="font-medium cursor-pointer flex items-center justify-between list-none">
                <span>How many consecutive games did he play?</span>
                <span class="text-slate-400 group-open:rotate-180 transition-transform">‚åÑ</span>
              </summary>
              <p class="text-sm text-slate-600 mt-2">2,130 consecutive games, earning him the nickname "Iron Horse"</p>
            </details>
            <details class="py-3 group">
              <summary class="font-medium cursor-pointer flex items-center justify-between list-none">
                <span>What is ALS?</span>
                <span class="text-slate-400 group-open:rotate-180 transition-transform">‚åÑ</span>
              </summary>
              <p class="text-sm text-slate-600 mt-2">Amyotrophic Lateral Sclerosis, also known as Lou Gehrig's disease</p>
            </details>
          </div>
          <div class="mt-4 flex items-center justify-between">
            <a href="/faq" class="text-blue-700 hover:underline text-sm">View all FAQs ‚Üí</a>
            <span id="faq-count" class="text-xs text-slate-500"></span>
          </div>
          <form id="ask-form" class="mt-6 space-y-3">
            <textarea id="ask-question" class="w-full border rounded px-3 py-2 text-slate-900 placeholder-gray-500" rows="3" placeholder="Ask a question‚Ä¶"></textarea>
            <input id="ask-email" class="w-full border rounded px-3 py-2 text-slate-900 placeholder-gray-500" type="email" placeholder="Your email (optional)" />
            <div class="flex items-center justify-between">
              <button type="submit" class="inline-flex items-center px-4 py-2 bg-slate-900 text-white rounded hover:bg-slate-800">Submit Question</button>
              <span id="ask-status" class="text-sm text-slate-600"></span>
            </div>
          </form>
        </div>
        <div class="border border-slate-200 rounded-xl bg-white p-6 shadow-sm flex flex-col">
          <h3 class="text-xl font-semibold mb-4">Lou Gehrig's Career Milestones</h3>
          <div class="flex-1 flex flex-col items-center justify-center gap-4">
            <div class="aspect-square w-32 bg-slate-100 rounded-full overflow-hidden flex items-center justify-center">
              <img src="https://readdy.ai/api/search-image?query=vintage%20Yankees%20baseball%20photo%20of%20Lou%20Gehrig%20%2C%20classic%20black%20and%20white%20style&width=300&height=300" alt="Lou Gehrig career highlights" class="w-full h-full object-cover" />
            </div>
            <a href="/milestones" class="btn-primary w-full text-center">View Career Milestones</a>
          </div>
        </div>
      </div>
    </div>

    <!-- Fan Club Event Calendar (placeholder, to be wired dynamically) -->
    <div class="py-16 px-6 bg-white">
      <div class="max-w-6xl mx-auto">
        <h2 class="text-3xl font-bold text-center mb-12">Fan Club Event Calendar</h2>
        <div class="border border-slate-200 rounded-xl bg-white p-6 shadow-sm">
          <div class="space-y-4" id="fanclub-events">
            <div class="flex items-center justify-between p-4 bg-slate-50 rounded-lg">
              <div>
                <h4 class="font-medium">Monthly Fan Club Meeting</h4>
                <p class="text-sm text-slate-600">Bronx Community Center</p>
              </div>
              <a href="/events" class="text-sm text-blue-700 hover:underline">Details</a>
            </div>
            <div class="flex items-center justify-between p-4 bg-slate-50 rounded-lg">
              <div>
                <h4 class="font-medium">Gehrig Trivia Night</h4>
                <p class="text-sm text-slate-600">Mickey Mantle's Restaurant</p>
              </div>
              <a href="/events" class="text-sm text-blue-700 hover:underline">Details</a>
            </div>
            <div class="flex items-center justify-between p-4 bg-slate-50 rounded-lg">
              <div>
                <h4 class="font-medium">Yankees Spring Training Trip</h4>
                <p class="text-sm text-slate-600">Tampa, FL</p>
              </div>
              <a href="/events" class="text-sm text-blue-700 hover:underline">Details</a>
            </div>
          </div>
        </div>
      </div>
    </div>

  </section>

  <script type="module">
    const askForm = document.getElementById('ask-form');
    const askQuestion = document.getElementById('ask-question');
    const askEmail = document.getElementById('ask-email');
    const askStatus = document.getElementById('ask-status');
    const faqSearch = document.getElementById('faq-search');
    const faqList = document.getElementById('faq-list');
    const faqCount = document.getElementById('faq-count');

    async function tryLoadEvents() {
      try {
        const eventsWrap = document.getElementById('fanclub-events');
        if (!eventsWrap) return;
        
        // Add loading indicator
        const loadingDiv = document.createElement('div');
        loadingDiv.className = 'flex items-center justify-center p-4 bg-slate-50 rounded-lg text-slate-600';
        loadingDiv.innerHTML = 'üîÑ Loading upcoming events...';
        eventsWrap.appendChild(loadingDiv);
        
        // Dynamically import client only when needed to avoid SSR issues
        const { createClient } = await import('../lib/supabase-client.js');
        const supabase = createClient();
        const { data, error } = await supabase
          .from('events')
          .select('id, title, start_at, location, link_url, is_club_event')
          .eq('is_club_event', true)
          .gte('start_at', new Date(Date.now() - 24*60*60*1000).toISOString())
          .order('start_at', { ascending: true })
          .limit(9);
        
        // Remove loading indicator
        eventsWrap.removeChild(loadingDiv);
        
        if (error) {
          console.warn('Events query error:', error.message);
          return; // Fall back to static content
        }
        
        if (!data || data.length === 0) {
          // Show message about no upcoming events but keep static content
          const noEventsDiv = document.createElement('div');
          noEventsDiv.className = 'text-center p-4 bg-blue-50 rounded-lg text-blue-800 text-sm mb-4';
          noEventsDiv.innerHTML = 'üìÖ No upcoming club events scheduled. Check back soon!';
          eventsWrap.insertBefore(noEventsDiv, eventsWrap.firstChild);
          return;
        }
        
        // Replace static content with dynamic events
        eventsWrap.innerHTML = '';
        for (const ev of data) {
          const div = document.createElement('div');
          div.className = 'flex items-center justify-between p-4 bg-slate-50 rounded-lg';
          const when = new Date(ev.start_at).toLocaleDateString();
          div.innerHTML = `
            <div>
              <h4 class="font-medium">${ev.title}</h4>
              ${ev.location ? `<p class="text-sm text-slate-600">${ev.location}</p>` : ''}
            </div>
            ${ev.link_url ? `<a href="${ev.link_url}" target="_blank" rel="noopener" class="text-sm text-blue-700 hover:underline">Details</a>` : `<span class="text-xs font-semibold bg-slate-200 text-slate-800 px-2 py-1 rounded">${when}</span>`}
          `;
          eventsWrap.appendChild(div);
        }
        
        // Add success indicator
        console.log('‚úÖ Events loaded successfully:', data.length, 'events');
        
      } catch (e) { 
        console.warn('Events loading failed:', e.message); 
        // Remove any loading indicators and fall back to static content
        const loadingDiv = document.getElementById('fanclub-events')?.querySelector('[class*="Loading"]');
        if (loadingDiv) {
          loadingDiv.remove();
        }
      }
    }

    function updateFaqCount() {
      const total = faqList?.querySelectorAll('details').length || 0;
      const visible = [...faqList?.querySelectorAll('details') || []].filter(d => d.style.display !== 'none').length;
      faqCount.textContent = total ? `${visible}/${total} shown` : '';
    }

    faqSearch?.addEventListener('input', () => {
      const term = faqSearch.value.trim().toLowerCase();
      const items = faqList.querySelectorAll('details');
      items.forEach(item => {
        const text = item.textContent?.toLowerCase() || '';
        item.style.display = term && !text.includes(term) ? 'none' : '';
      });
      updateFaqCount();
    });

    updateFaqCount();
    tryLoadEvents();

    if (askForm) {
      askForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const question = askQuestion.value.trim();
        if (!question || question.length < 5) {
          askStatus.textContent = 'Please enter a question (at least 5 characters).';
          askStatus.className = 'text-sm text-red-600';
          return;
        }
        
        askStatus.textContent = 'Sending your question...';
        askStatus.className = 'text-sm text-blue-600';
        
        try {
          const res = await fetch('/.netlify/functions/submit-question', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ question: askQuestion.value, email: askEmail.value })
          });
          
          if (!res.ok) {
            throw new Error(`Server responded with ${res.status}`);
          }
          
          const result = await res.json();
          
          if (result.ok) {
            if (result.stored) {
              askStatus.textContent = 'Thanks! Your question has been submitted and saved.';
              askStatus.className = 'text-sm text-green-600';
            } else {
              askStatus.textContent = 'Thanks! Your question was received (database unavailable but logged).';
              askStatus.className = 'text-sm text-yellow-600';
            }
            askQuestion.value = '';
            askEmail.value = '';
          } else {
            throw new Error('Submission failed');
          }
        } catch (err) {
          console.error('Question submission error:', err);
          askStatus.textContent = 'Sorry, something went wrong. Please try again later.';
          askStatus.className = 'text-sm text-red-600';
        }
      });
    }

    // Voting
    document.querySelectorAll('.vote-btn').forEach(btn => {
      btn.addEventListener('click', async () => {
        const imageId = btn.getAttribute('data-image');
        const originalText = btn.textContent;
        
        try {
          btn.textContent = 'Voting...';
          btn.disabled = true;
          
          const response = await fetch('/.netlify/functions/vote', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ image_id: imageId })
          });
          
          if (response.ok) {
            const result = await response.json();
            if (result.ok) {
              btn.textContent = 'Voted!';
              btn.className = btn.className.replace('btn-secondary', 'btn-primary');
              setTimeout(() => {
                window.location.href = '/leaderboard';
              }, 1000);
            } else {
              throw new Error('Vote not recorded');
            }
          } else {
            throw new Error(`Server error: ${response.status}`);
          }
        } catch (e) { 
          console.warn('Voting failed:', e.message); 
          btn.textContent = 'Vote Failed';
          btn.className = btn.className.replace('btn-secondary', 'border-red-500 text-red-600');
          setTimeout(() => {
            btn.textContent = originalText;
            btn.className = btn.className.replace('border-red-500 text-red-600', 'btn-secondary');
            btn.disabled = false;
          }, 3000);
        }
      });
    });
  </script>
</BaseLayout>
