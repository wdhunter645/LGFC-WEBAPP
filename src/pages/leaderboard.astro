---
import BaseLayout from "../layouts/BaseLayout.astro";
---

<BaseLayout title="Picture Vote Leaderboard | Lou Gehrig Fan Club" description="Top images by votes (overall and today).">
  <section class="max-w-5xl mx-auto p-6">
    <h1 class="text-3xl font-bold mb-4">Leaderboard</h1>

    <!-- Last Week's Winner -->
    <div class="mb-8">
      <h2 class="text-2xl font-semibold mb-3">Last Week's Winner</h2>
      <div class="border rounded overflow-hidden bg-white max-w-sm">
        <div class="w-full h-48 bg-gray-200 flex items-center justify-center">
          <div class="text-center text-gray-500">
            <div class="text-4xl mb-2">üèÜ</div>
            <div class="text-sm">Winner Photo</div>
          </div>
        </div>
        <div class="p-3 text-center">
          <div class="font-semibold text-gray-800">Last Week's Winner!</div>
          <div class="text-sm text-gray-600 mt-1">Congratulations to our champion(s)!</div>
        </div>
      </div>
    </div>

    <!-- Previous Round Winner -->
    <div id="previous-winner" class="mb-8 hidden">
      <h2 class="text-2xl font-semibold mb-3">Previous Round Winner</h2>
      <div id="winner-card" class="border rounded overflow-hidden bg-white max-w-sm">
        <img id="winner-image" src="" alt="" class="w-full h-48 object-cover" />
        <div class="p-3">
          <div id="winner-title" class="font-semibold"></div>
          <div id="winner-votes" class="text-sm text-gray-600"></div>
        </div>
      </div>
    </div>

    <!-- Current Round Status -->
    <div id="current-round" class="mb-8 hidden">
      <h2 class="text-2xl font-semibold mb-3">Current Round</h2>
      <div id="round-info" class="bg-blue-50 border border-blue-200 rounded p-4">
        <div id="round-number" class="font-semibold text-blue-800"></div>
        <div id="round-dates" class="text-sm text-blue-600"></div>
        <div id="round-progress" class="text-sm text-blue-600"></div>
      </div>
    </div>

    <h2 class="text-2xl font-semibold mt-4">Today</h2>
    <p id="today-status" class="text-gray-600">Loading‚Ä¶</p>
    <div id="today" class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-2"></div>

    <h2 class="text-2xl font-semibold mt-8">Overall</h2>
    <p id="all-status" class="text-gray-600">Loading‚Ä¶</p>
    <div id="all" class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-2"></div>
  </section>

  <script type="module">
    import { createClient } from '../lib/supabase-client.js';
    const supabase = createClient();

    const todayEl = document.getElementById('today');
    const allEl = document.getElementById('all');
    const todayStatus = document.getElementById('today-status');
    const allStatus = document.getElementById('all-status');
    const previousWinner = document.getElementById('previous-winner');
    const currentRound = document.getElementById('current-round');
    const winnerCard = document.getElementById('winner-card');
    const winnerImage = document.getElementById('winner-image');
    const winnerTitle = document.getElementById('winner-title');
    const winnerVotes = document.getElementById('winner-votes');
    const roundInfo = document.getElementById('round-info');
    const roundNumber = document.getElementById('round-number');
    const roundDates = document.getElementById('round-dates');
    const roundProgress = document.getElementById('round-progress');

    function card(img, votes) {
      const div = document.createElement('div');
      div.className = 'border rounded overflow-hidden bg-white';
      const url = img.media_url || img.url || '/placeholder.svg';
      const alt = img.alt_text || img.file_name || 'Photo';
      div.innerHTML = `
        <img src="${url}" alt="${alt}" class="w-full h-40 object-cover" loading="lazy" />
        <div class="p-2 text-sm flex items-center justify-between">
          <span class="truncate">${alt}</span>
          <span class="font-semibold">${votes}</span>
        </div>
      `;
      return div;
    }

    async function loadToday() {
      todayStatus.textContent = 'Loading‚Ä¶';
      const { data, error } = await supabase
        .from('picture_votes')
        .select('image_id, voted_at, media_files!inner(id, media_url, alt_text, file_name)')
        .gte('voted_at', new Date().toISOString().slice(0,10))
        .limit(10000);
      if (error) { todayStatus.textContent = `Error: ${error.message}`; return; }
      const map = new Map();
      for (const row of data ?? []) {
        const key = row.image_id;
        map.set(key, (map.get(key) || 0) + 1);
      }
      const items = [...map.entries()].sort((a,b) => b[1]-a[1]).slice(0,12);
      todayEl.innerHTML = '';
      for (const [image_id, votes] of items) {
        const img = (data ?? []).find(d => d.image_id === image_id)?.media_files || {};
        todayEl.appendChild(card(img, votes));
      }
      todayStatus.textContent = items.length ? '' : 'No votes today.';
    }

    async function loadAll() {
      allStatus.textContent = 'Loading‚Ä¶';
      const { data, error } = await supabase
        .from('picture_votes')
        .select('image_id, media_files!inner(id, media_url, alt_text, file_name)')
        .limit(100000);
      if (error) { allStatus.textContent = `Error: ${error.message}`; return; }
      const map = new Map();
      for (const row of data ?? []) {
        const key = row.image_id;
        map.set(key, (map.get(key) || 0) + 1);
      }
      const items = [...map.entries()].sort((a,b) => b[1]-a[1]).slice(0,12);
      allEl.innerHTML = '';
      for (const [image_id, votes] of items) {
        const img = (data ?? []).find(d => d.image_id === image_id)?.media_files || {};
        allEl.appendChild(card(img, votes));
      }
      allStatus.textContent = items.length ? '' : 'No votes recorded.';
    }

    async function loadVotingRounds() {
      // Load current round
      const { data: currentRoundData, error: currentError } = await supabase.rpc('get_current_voting_round');
      if (!currentError && currentRoundData?.[0]) {
        const round = currentRoundData[0];
        currentRound.classList.remove('hidden');
        roundNumber.textContent = `Round ${round.round_number}`;
        roundDates.textContent = `${new Date(round.start_date).toLocaleDateString()} - ${new Date(round.end_date).toLocaleDateString()}`;
        
        // Get round progress
        const { data: roundImages } = await supabase
          .from('round_images')
          .select('votes_received')
          .eq('round_id', round.round_id);
        
        const totalVotes = (roundImages || []).reduce((sum, img) => sum + img.votes_received, 0);
        roundProgress.textContent = `${totalVotes} total votes`;
      }
      
      // Load previous winners
      const { data: previousWinnerData, error: previousError } = await supabase
        .from('voting_rounds')
        .select(`
          id,
          round_number,
          total_votes
        `)
        .eq('status', 'completed')
        .order('round_number', { ascending: false })
        .limit(1);
      
      if (!previousError && previousWinnerData?.[0]) {
        const round = previousWinnerData[0];
        
        // Get winners for this round
        const { data: winnersData, error: winnersError } = await supabase
          .from('round_winners')
          .select(`
            image_id,
            votes_received,
            media_files!inner(id, media_url, alt_text, file_name)
          `)
          .eq('round_id', round.id);
        
        if (!winnersError && winnersData?.length > 0) {
          previousWinner.classList.remove('hidden');
          
          if (winnersData.length === 1) {
            // Single winner
            const winner = winnersData[0];
            winnerImage.src = winner.media_files.media_url || '/placeholder.svg';
            winnerImage.alt = winner.media_files.alt_text || winner.media_files.file_name || 'Winner';
            winnerTitle.textContent = winner.media_files.alt_text || winner.media_files.file_name || 'Winner';
            winnerVotes.textContent = `${winner.votes_received} votes`;
          } else {
            // Multiple winners (tie)
            winnerImage.src = '/placeholder.svg';
            winnerImage.alt = 'Multiple Winners';
            winnerTitle.textContent = `${winnersData.length} Winners (Tie!)`;
            winnerVotes.textContent = `${winnersData[0].votes_received} votes each`;
          }
        }
      }
    }

    loadToday();
    loadAll();
    loadVotingRounds();
  </script>
</BaseLayout>