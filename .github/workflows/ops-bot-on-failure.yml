name: Ops-Bot: Alert on Workflow Failure

on:
  workflow_run:
    types:
      - completed
  workflow_dispatch:
  repository_dispatch:
    types: [ops-alert]

permissions:
  contents: write
  actions: read
  issues: write
  pull-requests: write

jobs:
  alert:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion != 'success' && github.event.workflow_run.name != 'Ops-Bot: Alert on Workflow Failure' && github.event.workflow_run.name != 'Ops-Bot: Triage Failed Runs' && github.event.workflow_run.name != 'Ops-Bot: Detect Missing Runs' }}
    env:
      EFFECTIVE_TOKEN: ${{ secrets.OPS_BOT_TOKEN != '' && secrets.OPS_BOT_TOKEN || github.token }}
    steps:
      - name: Token detection
        run: |
          if [ -n "${EFFECTIVE_TOKEN}" ]; then echo "Using effective token"; fi
      - name: Prepare alert body
        id: prep
        run: |
          NAME="${{ github.event.workflow_run.name }}"
          CONCLUSION="${{ github.event.workflow_run.conclusion }}"
          STATUS="${{ github.event.workflow_run.status }}"
          HTML_URL="${{ github.event.workflow_run.html_url }}"
          STARTED="${{ github.event.workflow_run.run_started_at }}"
          RUN_NUMBER="${{ github.event.workflow_run.run_number }}"
          REPO="${{ github.repository }}"
          BRANCH="${{ github.event.workflow_run.head_branch }}"
          COMMIT="${{ github.event.workflow_run.head_sha }}"

          cat > body.txt <<EOF
          # Ops Alert: ${NAME} failed

          - Repo: ${REPO}
          - Branch: ${BRANCH}
          - Run: #${RUN_NUMBER}
          - Status: ${STATUS}
          - Conclusion: ${CONCLUSION}
          - Started: ${STARTED}
          - Commit: ${COMMIT}
          - Logs: ${HTML_URL}

          Next: Investigate failing step, post root cause, and fix. If transient, note mitigation.
          EOF
          echo "body<<__BODY__" >> $GITHUB_OUTPUT
          cat body.txt >> $GITHUB_OUTPUT
          echo "__BODY__" >> $GITHUB_OUTPUT

      - name: Create or update consolidated Ops Alerts issue (no search API)
        uses: actions/github-script@v7
        continue-on-error: true
        env:
          PREPARED: ${{ steps.prep.outputs.body }}
        with:
          github-token: ${{ env.EFFECTIVE_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const title = 'Ops Alerts (auto)';
            const prepared = process.env.PREPARED || '';
            // List open issues and find by exact title (avoid search scope)
            const openIssues = await github.paginate(github.rest.issues.listForRepo, { owner, repo, state: 'open', per_page: 100 });
            const existing = openIssues.find(i => i.title === title);
            if (existing) {
              await github.rest.issues.createComment({ owner, repo, issue_number: existing.number, body: prepared });
              core.summary.addHeading('Updated Ops Alerts issue').addLink(title, existing.html_url).write();
            } else {
              const { data: created } = await github.rest.issues.create({ owner, repo, title, body: prepared, labels: ['ops', 'alert'] });
              core.summary.addHeading('Created Ops Alerts issue').addLink(title, created.html_url).write();
            }

      - name: Optional Slack notification
        if: always()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ -n "${SLACK_WEBHOOK_URL}" ]; then
            NAME="${{ github.event.workflow_run.name }}"
            CONCLUSION="${{ github.event.workflow_run.conclusion }}"
            HTML_URL="${{ github.event.workflow_run.html_url }}"
            REPO="${{ github.repository }}"
            BRANCH="${{ github.event.workflow_run.head_branch }}"
            TEXT="Ops Alert: ${NAME} (${REPO}@${BRANCH}) — ${CONCLUSION}. ${HTML_URL}"
            PAYLOAD=$(printf '{"text":"%s"}' "${TEXT}")
            curl -s -X POST -H 'Content-type: application/json' --data "${PAYLOAD}" "${SLACK_WEBHOOK_URL}" || true
          else
            echo "No SLACK_WEBHOOK_URL configured; skipping Slack notification."
          fi

      - name: Checkout repository for PR log
        uses: actions/checkout@v4

      - name: Append alert to infra/OPS_ALERTS_LOG.md
        run: |
          mkdir -p infra
          echo "" >> infra/OPS_ALERTS_LOG.md
          echo "## ${{ github.event.workflow_run.name }} — ${{ github.event.workflow_run.conclusion }} (run #${{ github.event.workflow_run.run_number }})" >> infra/OPS_ALERTS_LOG.md
          echo "- Repo: ${{ github.repository }}" >> infra/OPS_ALERTS_LOG.md
          echo "- Branch: ${{ github.event.workflow_run.head_branch }}" >> infra/OPS_ALERTS_LOG.md
          echo "- Started: ${{ github.event.workflow_run.run_started_at }}" >> infra/OPS_ALERTS_LOG.md
          echo "- Logs: ${{ github.event.workflow_run.html_url }}" >> infra/OPS_ALERTS_LOG.md

      - name: Create PR with alert log entry
        uses: peter-evans/create-pull-request@v6
        continue-on-error: true
        with:
          token: ${{ env.EFFECTIVE_TOKEN }}
          commit-message: "ops-bot: log ${{ github.event.workflow_run.name }} failure (run #${{ github.event.workflow_run.run_number }})"
          branch: "cursor/ops-bot/alerts-${{ github.run_id }}"
          title: "ops-bot: log ${{ github.event.workflow_run.name }} failure (#${{ github.event.workflow_run.run_number }})"
          body: "Automated alert log entry. See run: ${{ github.event.workflow_run.html_url }}"
          committer: "ops-bot <ops-bot@users.noreply.github.com>"
          author: "ops-bot <ops-bot@users.noreply.github.com>"
